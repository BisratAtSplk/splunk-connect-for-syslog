log {
    source(s_DEFAULT);

    if {
        filter(f_is_rfc5424_strict);
        rewrite { r_set_splunk_dest_default(sourcetype("sc4s:fallback"), index("main")); };
        parser { p_add_context_splunk(key("sc4s_fallback")); };
        rewrite { set("$(template ${.splunk.sc4s_template} $(template t_JSON_5424))" value("MSG")); };
    {{- if or (conv.ToBool (getenv "SC4S_DEST_SPLUNK_HEC_GLOBAL" "yes")) (conv.ToBool (getenv "SC4S_DEST_FALLBACK_HEC" "no")) }}
        destination(d_hec);
    {{- end}}


{{- if or (conv.ToBool (getenv "SC4S_ARCHIVE_GLOBAL" "no")) (conv.ToBool (getenv "SC4S_ARCHIVE_FALLBACK" "no")) }}

        #in fallback archive write rawmsg as msg
        rewrite {
            set("$RAWMSG" value("MSG"));
            unset(value("RAWMSG"));
            groupunset(values(".kv.*"));
        };
        destination(d_archive);
    {{- end}}

    } else {
        rewrite { r_set_splunk_dest_default(sourcetype("sc4s:fallback"), index("main")); };
        parser { p_add_context_splunk(key("sc4s_fallback")); };
        rewrite { set("$(template ${.splunk.sc4s_template} $(template t_JSON))" value("MSG")); };

    {{- if or (conv.ToBool (getenv "SC4S_DEST_SPLUNK_HEC_GLOBAL" "yes")) (conv.ToBool (getenv "SC4S_DEST_FALLBACK_HEC" "no")) }}
        destination(d_hec);
    {{- end}}


{{- if or (conv.ToBool (getenv "SC4S_ARCHIVE_GLOBAL" "no")) (conv.ToBool (getenv "SC4S_ARCHIVE_FALLBACK" "no")) }}

        #in fallback archive write rawmsg as msg
        rewrite {
            set("$RAWMSG" value("MSG"));
            unset(value("RAWMSG"));
            unset(value("PROGRAM"));
            unset(value("LEGACY_MSGHDR"));
            groupunset(values(".kv.*"));
        };
        destination(d_archive);

    {{- end}}

    };

    flags(flow-control,fallback);
};
